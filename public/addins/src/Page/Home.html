<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BRIKNOW</title>

    <script src="https://briknow.bri.co.id/addins/assets/Scripts/Office/1/office.js" type="text/javascript"></script>

    <!-- style-->
    <link href="https://briknow.bri.co.id/addins/assets/Content/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="https://briknow.bri.co.id/addins/assets/Content/bootstrap/all.css" rel="stylesheet">
    <link href="https://briknow.bri.co.id/addins/assets/Content/Custom.css" rel="stylesheet">
    <style>
        .kaki{
            bottom: 0px;
            position: fixed;
            display: block;
            width: 100%;
        }
        .result_pencarian{
            max-width: 540px;
            overflow:hidden;
            border-radius: 22px;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }
        .form-search{
            font-size: 10px;
        }
        .img_pencarian{
            width: 100%;
            height: 100%;
            min-height: 130px;
        }
    </style>

    <!-- js-->
    <script src="Home.js" type="text/javascript"></script>
    <!-- sweet alert -->
    <script src="https://briknow.bri.co.id/addins/assets/Scripts/sweetalert/sweetalert2.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-primary text-white">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="https://briknow.bri.co.id/addins/assets/bri know-white.png" alt="" width="100px" height="24">
            </a>
            <button class="navbar-toggler text-white" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link text-white" aria-current="page" href="Home.html">
                            <svg class="w-6 h-6 me-1" width="19px" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Pencarian
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="Download.html">
                            <svg class="w-6 h-6 me-1" width="19px" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg>
                            Download
                        </a>
                    </li>
                    <li class="nav-item">
                        <button class="btn nav-link text-white" onClick="logout()">
                            <svg class="w-6 h-6 me-1" width="19px" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="pt-4 search-section bg-white">
        <div class="row mx-2">
            <div class="col-md-12">
                <div class="d-flex justify-content-center">
                    <img src="https://briknow.bri.co.id/addins/assets/bri know.png" width="150px" alt="">
                </div>
            </div>
        </div>
        <div class="row mx-2 d-flex justify-content-center">
            <div class="col-md-8 mt-4">
                <form action="#" id="form_search">
                    <div class="input-group mb-1 pencarian-form">
                        <span class="input-group-text">
                            <svg class="w-6 h-6" fill="none" width="15px" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </span>
                        <input type="text" id="key" class="form-control no-shadow form-search" placeholder="Cari Nama Project, Metodologi, dan lainnya" />
                        <button type="submit" class="input-group-text btn btn-primary btn-sm no-shadow">Search</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="container content-isi mb-4">
        <div class="pb-4">
            <div id="load"></div>
            <div class="row mt-3" id="list"></div>
        </div>
    </div>
    <footer class="footer py-3 bg-light kaki">
        <div class="container">
            <div class="d-flex justify-content-between">
                <div>
                    <small class="text-muted">BRIKNOW v1.0</small>
                </div>
                <div>
                    <small class="text-muted" id="supportedVersion"></small>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://briknow.bri.co.id/addins/assets/Scripts/jquery-3.6.0.js" type="text/javascript"></script>
    <script src="https://briknow.bri.co.id/addins/assets/Scripts/bootstrap/popper.min.js" type="text/javascript"></script>
    <script src="https://briknow.bri.co.id/addins/assets/Scripts/bootstrap/bootstrap.min.js" type="text/javascript"></script>
    <script>
        let personal_number = localStorage.getItem("personal_number");
        let email = localStorage.getItem("email");
        let username = localStorage.getItem("username");
        let token = localStorage.getItem("token");
        let BE = `http://172.18.39.68/`;
        let FE = `https://briknow.bri.co.id/addins/`;
        localStorage.removeItem('detail');

        if(personal_number === null){
            window.location.replace("Login.html");
        }else{
            let endpoint = `${BE}api/cek_auth`;
            $.ajax({
                url: endpoint,
                contentType: "application/json",
                type: "post",
                dataType: 'json',
                headers: {"Authorization": `Bearer ${localStorage.getItem("token")}`},
                success: function(response){
                    if(response.status === '1'){}else{
                        localStorage.removeItem("personal_number");
                        localStorage.removeItem("email");
                        localStorage.removeItem("username");
                        localStorage.removeItem("token");

                        window.location.replace("Login.html");
                    }
                },
                error : function(e){
                    localStorage.removeItem("personal_number");
                    localStorage.removeItem("email");
                    localStorage.removeItem("username");
                    localStorage.removeItem("token");

                    window.location.replace("Login.html");
                }
            })
        }

        $("#form_search").submit(function(event){
            event.preventDefault();
            cari();
        });

        function cari(){
            let key = $("#key").val();
            if(key !== "") {
                let endpoint = BE+'api/search'+'/'+key;
                //console.log(endpoint);
                $.ajax({
                    url: endpoint,
                    contentType: "application/json",
                    type: "post",
                    dataType: 'json',
                    headers: {"Authorization": `Bearer ${localStorage.getItem("token")}`},
                    beforeSend: function(){
                        $('#list').html(``);
                        $('#load').html(`Please Wait . . . `);
                    },
                    success: function(response){
                        //console.log(response);
                        $('#load').html(``);
                        if(response.status === 1 || response.status === '1'){
                            if(response.data.data.length > 0){
                                document.getElementById("list").innerHTML = ``;
                                for(i = 0; i < response.data.data.length; i++){
                                    let image;
                                    if(response.data.data[i]._source.thumbnail == null){
                                        image = `${FE}assets/gedung.png`;
                                    }else{
                                        image = `${BE}storage/${response.data.data[i]._source.thumbnail}`;
                                    }
                                    var regX = /(<([^>]+)>)/ig;
                                    var temp = response.data.data[i]._source.deskripsi;
                                    temp     = temp.replace(regX, "");
                                    if(temp.length > 45) temp = temp.substring(0,45)
                                    document.getElementById("list").innerHTML += `
                                        <div class="col-md-6 col-sm-12 justify-content-center">
                                            <div class="card mb-3 result_pencarian">
                                                <a href="Detail.html" onclick="setDetail('${response.data.data[i]._source.id}')" style="text-decoration: none;">
                                                    <div class="row g-0">
                                                        <div class="col-md-3 col-sm-4 col-xs-4">
                                                            <img src="${image}" class="img_pencarian" alt="...">
                                                        </div>
                                                        <div class="col-md-9 col-sm-8 col-xs-8">
                                                            <div class="card-body text-dark">
                                                                <small class="text-muted">${response.data.data[i]._source.direktorat}<span class="d-10 mx-1">&middot;</span>${response.data.data[i]._source.divisi}</small>
                                                                <h5 class="card-title mb-0">${response.data.data[i]._source.nama}</h5>
                                                                <p class="card-text fw-lighter">${temp}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>
                                            </div>
                                        </div>
                                    `;
                                }
                            }else{
                                document.getElementById("list").innerHTML = `
                                    <div class="row d-flex justify-content-center">
                                        <div class="col-md-4 mt-4">
                                            <div class="card-section">
                                                <p>
                                                    Penelusuran Anda - <span><em><b>${key}</b></em></span> - tidak cocok dengan dokumen apa pun.
                                                </p>
                                                <p class="mt-2">Saran:</p>
                                                <ul class="mb-1">
                                                    <li>Pastikan semua kata dieja dengan benar.</li>
                                                    <li>Coba kata kunci yang lain.</li>
                                                    <li>Coba kata kunci yang lebih umum.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }else{
                            $('#list').html(``);
                            $('#load').html(``);
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                                })
                            Toast.fire({
                            icon: 'error',
                            title: response.data.data.message
                            })
                        }
                    },
                    error : function(e){
                        $('#load').html(``);
                        $('#list').html(``);
                    }
                });
            }else{
                $('#list').html(``);
                $('#load').html(``);
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                })
                Toast.fire({
                    icon: 'error',
                    title: 'Form Pencarian Kosong!'
                })
            }
        }

        function setDetail(id){
            localStorage.setItem('detail',id);
        }

        function logout(){
            let endpoint = `${BE}api/logout`;
            $.ajax({
                url: endpoint,
                contentType: "application/json",
                type: "post",
                dataType: 'json',
                headers: {"Authorization": `Bearer ${localStorage.getItem("token")}`},
                beforeSend: function(){
                },
                success: function(response){
                    if(response.status === '1'){
                        localStorage.removeItem("personal_number");
                        localStorage.removeItem("email");
                        localStorage.removeItem("username");
                        localStorage.removeItem("token");
                        window.location.replace("Login.html");
                    }else{
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                              toast.addEventListener('mouseenter', Swal.stopTimer)
                              toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                          })
                          Toast.fire({
                            icon: 'error',
                            title: 'Logout Failed!'
                          })
                    }
                },
                error : function(e){
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                          toast.addEventListener('mouseenter', Swal.stopTimer)
                          toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                      })
                      Toast.fire({
                        icon: 'error',
                        title: 'Logout Failed!'
                      })
                }
            })
        }
    </script>
</body>
</html>
